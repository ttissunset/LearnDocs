### ==1. 浏览器渲染流程==

#### 1.1 网络

- **构建请求**：浏览器开启网络请求线程，向服务器发送完整的http请求。
- **查找缓存**：真正发起网络请求之前，浏览器会先在数据存储中查询是否有需要请求的文件。如果没有任何缓存，说明第一次请求，则进入网络请求过程。当浏览器有缓存的时候，会拦截请求，返回缓存，拦截请求。缓存优点：缓解服务器压力，提升性能，实现快速加载资源。
- **准备IP地址和端口**：通过 URL 地址获取 ip 地址和端口信息，通过 DNS 解析返回域名对应的 ip 和 port ，浏览器也提供了 dns 数据缓存，通常 url 没有指明端口号，则默认80。
- **等待TCP队列**：chrome 有个机制，同一域名下同时最多只能建立6个TCP连接，如果同时有10个请求发生，其中4个就会进入等待队列，直至进行中的请求完成，如果小于6个，则直接进入TCP 连接。
- **建立TCP连接**：浏览器与服务器之间通过 TCP 建立连接。TCP协议提供可靠的连接服务，采用三次握手建立一个连接。
- **发送http请求**：连接建立成功之后，浏览器就可以与服务器之间通讯了。浏览器会向服务器发送请求信息，包括请求方法、请求 URL、http 版本协议。
- **服务器处理请求**：服务端收到请求信息以后，会根据浏览器的请求信息返回结果，返回结果中包含三部分：响应行、响应头、响应体。响应行内包含状态码，告诉浏览器处理结果，http状态码有很多。响应头包含服务器自身的一些信息，响应体就包含了网页的 html 实际内容。
- **服务器响应和断开连接**：通常服务器向浏览器返回请求数据之后，就会关闭连接，经过四次分手之后，就断开连接了

![image-20250806233412895](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20250806233412895.png)

#### 1.2 渲染

##### 1.2.1 **==解析 HTML==**：解析 HTML 生成 DOM 树。

- 将字节数据转换为字符串后进行标记化，解析出 `HTML` 标签和内容分析 `DOM` 结点**==生成 `DOM` 树==**

![image-20250806214008824](https://gitee.com/phenylaminopropionic-acid/photo/raw/master/image-20250806214008824.png)

- 解析 HTML 同时开启一个 **==预解析线程==**，提前通过 `link` 下载和解析 CSS 
  - ==**因为预解析线程的存在，CSS 的下载和解析不会阻塞 HTML 的解析**==
  - CSS 同样经历字节转字符串，标记化后，**==生成 CSSOM 树==**

![image-20250806214200997](https://gitee.com/phenylaminopropionic-acid/photo/raw/master/image-20250806214200997.png)

- 在预解析线程中，通过 `script` 标签下载和解析 JS 
  - 当解析到 script 时，**==会停止解析 HTMl 并等待 js文件下载并执行完毕==**，才会继续解析 HTMl
  - 因此 **==js 会阻塞 HTML 的解析即渲染主线程==**

![image-20250806214757324](https://gitee.com/phenylaminopropionic-acid/photo/raw/master/image-20250806214757324.png)

##### 1.2.2 **==样式计算==**：计算每个 DOM 节点的最终样式。

- **==主线程==**会遍历得到的 DOM 树，依次为树中的结点计算出样式生成新的 DOM 树
  - 在此过程中，会**将预设值变为绝对值**如 `red --> rgb(255,0,0)`、`em --> px`等

![image-20250806215334200](https://gitee.com/phenylaminopropionic-acid/photo/raw/master/image-20250806215334200.png)

- 注意：样式计算会对所有的 DOM 结点计算出**所有的样式属性值**，包括未定义的

##### 1.2.3 **==布局==**：计算每个节点的几何信息。

- **==主线程遍==**历新生成的 DOM 树并根据每个节点的计算样式计算出布局树 `layout tree`

  ![image-20250806223050924](https://gitee.com/phenylaminopropionic-acid/photo/raw/master/image-20250806223050924.png)

  - 注意：DOM 树和 Layout 树**==并非一一对应==**，**==布局树只包含可见的节点信息==**
  - 匿名行盒和匿名块盒也会导致 DOM 树和布局树无法一一对应

  ![image-20250806223510574](https://gitee.com/phenylaminopropionic-acid/photo/raw/master/image-20250806223510574.png)

##### 1.2.4 **==分层==**：将页面划分为多个图层。 --> 类似于 Photoshop 的图层

- 当某一层改变时，**只需要对该层进行处理**而无需改变整个结构，从而**提高效率**
- **==主线程==**遍历布局树创建层次树 `Layer tree`
  - 可以通过设置 `will-change：某个属性` 来单独分层

![image-20250806224050162](https://gitee.com/phenylaminopropionic-acid/photo/raw/master/image-20250806224050162.png)

##### 1.2.5 **==生成绘制指令==**：为每个图层生成绘制指令集。

- **==主线程==为==每一个层单独产生绘制指令集==**，描述这一层该如何画出来

![image-20250806224222166](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20250806224222166.png)

- **主线程**将每个图层的绘制信息提交给**==组合线程==**，**剩余工作交由组合线程完成**

![image-20250806224445355](https://gitee.com/phenylaminopropionic-acid/photo/raw/master/image-20250806224445355.png)

##### 1.2.6 **==分块==**：将每个图层划分为更小的块。

- **==合成线程==**为每个图层每块，划分为更多的小区域，**==交给多个线程完成分块区域的工作==**

![image-20250806224628474](https://gitee.com/phenylaminopropionic-acid/photo/raw/master/image-20250806224628474.png)

##### 1.2.7 **==光栅化==**：将每个块转换为位图。

- **==GPU 进程==**将每个块绘制成**==位图==**，即确认每个像素点的 `rgb` 信息

![image-20250806224753997](https://gitee.com/phenylaminopropionic-acid/photo/raw/master/image-20250806224753997.png)

##### 1.2.8 **==绘制==**：将位图绘制到屏幕上。

- 所有的图块都被光栅化后，**合成线程会生成一个个 ==`quad` 信息提交渲染帧==并交给 GPU 进行最后的绘制**

  - `quad` 会标识出每个位图应该出现在屏幕中的哪个位置如 `transform` 等

  ![image-20250806230136518](https://gitee.com/phenylaminopropionic-acid/photo/raw/master/image-20250806230136518.png)

![image-20250806225118483](https://gitee.com/phenylaminopropionic-acid/photo/raw/master/image-20250806225118483.png)



### 2 浏览器组成

- **用户界面**：**浏览器的界面**，有标签页、地址栏、前进、后退、刷新、收藏等页面
- **浏览器引擎**：用来**查询和操作渲染引擎的接口**
- **渲染引擎**：也叫做 “**浏览器内核**” ，用来**解析 `html、css` 并将结果以网页的形式显示**，不同浏览器渲染引擎也不同
- **网络**：用来网络调用，如前后端数据交互中的http请求
- **`js` 解释器**：用来解释执行js代码
- **`UI` 后端**：**绘制基础原件**，如组合框与窗口，提供平台无关的接口，内部使用操作系统的相应实现
- **数据存储**：属于**持久层**，浏览器需要把所有数据存到硬盘上，如 cookie、图片、css 等

![img](https://i-blog.csdnimg.cn/blog_migrate/b15f7b30d21fd9bd1971266485982220.jpeg)
